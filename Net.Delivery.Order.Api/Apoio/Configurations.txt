using Polly;
using Polly.Extensions.Http;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Teste_.Ocurrences.Application.Services.Outros;
using Projeto.Outross.Infra.Http.HttpClientFactory;
using Teste_.Ocurrences.Application.Services.OrderOutros;
using Projeto.Outross.Infra.OrderOutros.Client.Outros;
using Teste_.Ocurrences.Application.Services.Consequences;
using Teste_.Ocurrences.Application.Services.GatewayTeste;
using Teste_.Ocurrences.Application.Services.backEndt_1;
using Teste_.Ocurrences.Application.Services.backEndOutros;
using Teste_.Ocurrences.Application.Services.Authentication;
using Projeto.Outross.Infra.OrderOutros.Client.GatewayTeste;
using Projeto.Outross.Infra.OrderOutros.Client.Authentication;
using Projeto.Outross.Infra.OrderOutros.Client.backEndt_1;
using Projeto.Outross.Infra.OrderOutros.Client.backEndOutros;
using Projeto.Outross.Infra.OrderOutros.Client.TesteAPIExternalClient;
using Projeto.Outross.Infra.OrderOutros.Client.Teste_OrderMonitor;
using Projeto.Outross.Infra.OrderOutros.Client.OrderOutrosClient;
using Teste_.Ocurrences.Application.Services.Teste_OrderMonitor;
using Teste_.Ocurrences.Application.Services.CustomerSuccess;

namespace Projeto.Outross.Infra.Http;

public static class ConfigureDI
{
    public static void AddHttpFlurl(this IServiceCollection services, IConfiguration configuration)
    {
        services.AddTransient<LoggingHandler>();

        //para cada tipo de client precisa criar uma classe para usar aqui
        services.AddHttpClient<IAuthenticationTesteAPIExternalClient, AuthenticationTesteAPIExternalClient>(client =>
            {
                client.BaseAddress = new Uri(configuration.GetSection("BaseUrl:UrlOutros_01").Value!);
            })
            .AddHttpMessageHandler<LoggingHandler>()
            .AddPolicyHandler(GetRetryPolicy())
            .AddPolicyHandler(GetCircuitBreakerPolicy());

        services.AddHttpClient<ITesteAPIExternalClient, TesteAPIExternalClient>(client =>
            {
                client.BaseAddress = new Uri(configuration.GetSection("BaseUrl:UrlOutros_01").Value!);
            })
            .AddHttpMessageHandler<LoggingHandler>()
            .AddPolicyHandler(GetRetryPolicy())
            .AddPolicyHandler(GetCircuitBreakerPolicy());

        services.AddHttpClient<IbackEndt_1Client, backEndt_1Client>(client =>
            {
                client.BaseAddress = new Uri(configuration.GetSection("BaseUrl:Urlback_tetes").Value!);
            })
            .AddHttpMessageHandler<LoggingHandler>();

        services.AddHttpClient<IOrderOutrosClient, OrderOutrosClient>(client =>
            {
                client.BaseAddress = new Uri(configuration.GetSection("BaseUrl:UrlOrderOutros").Value!);
            })
            .AddHttpMessageHandler<LoggingHandler>();


        services.AddHttpClient<IbackEndOutrosClient, backEndOutrosClient>(client =>
            {
                client.BaseAddress = new Uri(configuration.GetSection("BaseUrl:UrlbackEndOutros").Value!);
            })
            .AddHttpMessageHandler<LoggingHandler>()
            .AddPolicyHandler(GetRetryPolicy())
            .AddPolicyHandler(GetCircuitBreakerPolicy());

        services.AddHttpClient<IOutrosClient, OutrosClient>(client =>
            {
                client.BaseAddress = new Uri(configuration.GetSection("BaseUrl:UrlOutros").Value!);
            })
            .AddHttpMessageHandler<LoggingHandler>()
            .AddPolicyHandler(GetRetryPolicy())
            .AddPolicyHandler(GetCircuitBreakerPolicy());

        services.AddHttpClient<IOutrosClient, OutrosClient>(client =>
            {
                client.BaseAddress = new Uri(configuration.GetSection("BaseUrl:UrlOutros").Value!);
            })
            .AddHttpMessageHandler<LoggingHandler>()
            .AddPolicyHandler(GetRetryPolicy())
            .AddPolicyHandler(GetCircuitBreakerPolicy());

        services.AddHttpClient<IGatewayTesteClient, GatewayTesteClient>(client =>
        {
            client.BaseAddress = new Uri(configuration.GetSection("BaseUrl:UrlGatewayTeste").Value!);

        }).AddHttpMessageHandler<LoggingHandler>();


        services.AddHttpClient<ITeste_OrderMonitorClient, Teste_OrderMonitorClient>(client =>
            {
                client.BaseAddress = new Uri(configuration.GetSection("BaseUrl:UrlDeliveryMonitorTeste").Value!);
            })
            .AddHttpMessageHandler<LoggingHandler>()
            .AddPolicyHandler(GetRetryPolicy())
            .AddPolicyHandler(GetCircuitBreakerPolicy());
    }

    public static IAsyncPolicy<HttpResponseMessage> GetRetryPolicy()
    {
        return HttpPolicyExtensions
            .HandleTransientHttpError()
            .WaitAndRetryAsync(3, retryAttempt => TimeSpan.FromSeconds(Math.Pow(2, retryAttempt)));
    }

    public static IAsyncPolicy<HttpResponseMessage> GetCircuitBreakerPolicy()
    {
        return HttpPolicyExtensions
            .HandleTransientHttpError()
            .CircuitBreakerAsync(3, TimeSpan.FromSeconds(10));
    }
}
















public class LoggingHandler : DelegatingHandler
{
    protected override async Task<HttpResponseMessage> SendAsync(HttpRequestMessage request, CancellationToken cancellationToken)
    {

        if (request.Content != null)
        {
            await request.Content.ReadAsStringAsync();
        }

        var response = await base.SendAsync(request, cancellationToken);

        // aqui pode ser removido para não poluir os logs
        if (response.Content != null)
        {
            await response.Content.ReadAsStringAsync();
        }

        if (!response.IsSuccessStatusCode)
        {
            // logar erros
        }

        return response;
    }
}